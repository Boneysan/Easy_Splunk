# Prometheus monitoring service
prometheus:
  image: "{{PROMETHEUS_IMAGE}}"
  container_name: "${COMPOSE_PROJECT_NAME:-myapp}_prometheus"
  restart: unless-stopped
  command:
    - '--config.file=/etc/prometheus/prometheus.yml'
    - '--storage.tsdb.path=/prometheus'
    - '--web.console.libraries=/etc/prometheus/console_libraries'
    - '--web.console.templates=/etc/prometheus/consoles'
    - '--storage.tsdb.retention.time=15d'
    - '--web.enable-lifecycle'
  ports:
    - "9090:9090"
  networks:
    - app-net
    - splunk-net
  volumes:
    - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    - prometheus-data:/prometheus
  profiles: ["monitoring"]
  {{#ENABLE_HEALTHCHECKS}}
  healthcheck:
    test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/healthy || exit 1"]
    interval: 20s
    timeout: 3s
    retries: 10
    start_period: 30s
  {{/ENABLE_HEALTHCHECKS}}
  deploy:
    resources:
      limits:
        cpus: '${PROMETHEUS_CPU_LIMIT:-1}'
        memory: '${PROMETHEUS_MEM_LIMIT:-1G}'
      reservations:
        cpus: '${PROMETHEUS_CPU_RESERVE:-0.5}'
        memory: '${PROMETHEUS_MEM_RESERVE:-512M}'
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
